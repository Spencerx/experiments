#!/bin/bash

WORK_DIR=""
INDEX=-1
REMOTE=0

while getopts "d:i:r" opt; do
  case $opt in
    d) WORK_DIR=$OPTARG;;
    i) INDEX=$OPTARG;;
    r) REMOTE=1;;
    :)
      echo "Usage: stop_process -d /path/to/work [-i controller_index] [-r]" >&2
      exit 1;;
    \?)
      echo "Usage: stop_process -d /path/to/work [-i controller_index] [-r]" >&2
      exit 1;;
  esac
done

# Work directory
if [ -z "$WORK_DIR"  ] || ! [ -d "$WORK_DIR" ]; then
  echo "Usage: stop_vms -d /path/to/work [-h] [-r]" >&2
  exit 1
fi
cd $WORK_DIR

# Check if vm exists
VM_TYPE="KvmNode"
if [ $REMOTE -eq 1 ]; then
  VM_TYPE="EsxVmNode"
fi
IP=$(make show-vms | grep -A 2 $VM_TYPE | egrep "ipaddr: [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" | sed 's/ipaddr://')
if [ -z "$IP" ]; then
  echo "No vm found!"
  exit 1
fi
IP=$(echo $IP | awk '{print $'$INDEX'}')

STATUS=$(ssh -o "StrictHostKeyChecking=no" root@$IP 'service floodlight stop; exit')
echo "Stop process ($IP): "$STATUS

