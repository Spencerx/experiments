#!/bin/bash

WORK_DIR=""
INDEX=-1

while getopts "d:i:" opt; do
  case $opt in
    d) WORK_DIR=$OPTARG;;
    i) INDEX=$OPTARG;;
    :)
      echo "Usage: check_power_state_vm -d /path/to/work [-i controller_index]" >&2
      exit 1;;
    \?)
      echo "Usage: check_power_state_vm -d /path/to/work [-i controller_index]" >&2
      exit 1;;
  esac
done

# Work directory
if [ -z "$WORK_DIR"  ] || ! [ -d "$WORK_DIR" ]; then
  echo "Usage: check_power_state_vm -d /path/to/work [-i controller_index]" >&2
  exit 1
fi
cd $WORK_DIR

# Check if vm exists
VM_TYPE="KvmNode"
if [ $REMOTE -eq 1 ]; then
  VM_TYPE="EsxVmNode"
fi
IP=$(make show-vms | grep -A 2 $VM_TYPE | egrep "ipaddr: [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" | sed 's/ipaddr://')
if [ -z "$IP" ]; then
  echo "No vm to check power state on!"
  exit 1
fi

# Check vm power state 
CMD="make check-power-state"
if [ $INDEX -lt 0 ]; then
  echo "Controller index not found!"
  exit 1
else
  CMD="${CMD}-node${INDEX}"
fi

echo $CMD
#$($CMD)

